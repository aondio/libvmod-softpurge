varnishtest "Test softpurge vmod"

server s1 {
	rxreq
	txresp

	# the purge restart target, avoiding vcl_error error which closes connection.
	rxreq
	txresp

	rxreq
	txresp

	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
	import softpurge from "${vmod_topbuild}/src/.libs/libvmod_softpurge.so";
	import std;

	backend b1 {
		.host = "${s1_addr}";
		.port = "${s1_port}";
	}

	backend b2 {
		.host = "127.0.0.1";
		.port = "12313";
	
	}
	sub vcl_recv {
		set req.http.grace = "none";	
		if (req.url == "/sick") {
		   set req.backend_hint = b2;
		   set req.http.x-backend = "sick";
		   } else {set req.backend_hint = b1;}
		   
		   
		   if (req.method == "PURGE") {
		      return(hash);
		   }
	}


	sub vcl_backend_response {
	    	set beresp.ttl = 10s;
	        set beresp.grace = 1h;
	}
	
	sub vcl_miss {
	set req.http.x-via = "miss";

	}
	sub vcl_hit {
	set req.http.x-via = "hit";
if (req.method == "PURGE") {
softpurge.softpurge();
set req.url = "/exists";
set req.method = "GET";
set req.http.x-via = "hit";
return(deliver);
}
  if (obj.ttl >= 0s) {
    # normal hit
    return (deliver);
  }
  # We have no fresh fish. Lets look at the stale ones.
  if (std.healthy(req.backend_hint)) {
    # Backend is healthy. Limit age to 10s.
    if (obj.ttl + 10s > 0s) {
      set req.http.grace = "normal(limited)";
      return (deliver);
    } else {
      # No candidate for grace. Fetch a fresh object.
      return(fetch);
   }
  } else {
    # backend is sick - use full grace
    if (obj.ttl + obj.grace > 0s) {
      set req.http.grace = "full";
      return (deliver);
    } else {
     # no graced object.
    return (fetch);
   }
  }
}

	sub vcl_deliver {
 	    	set resp.http.grace = req.http.grace;
		set resp.http.backend = req.http.backend;
		set resp.http.x-via = req.http.x-via;
	}

} -start


# Warm the cache
client c1 {
       txreq -url "/"
       rxresp
       txreq -url "/"
       rxresp
       expect resp.status == 200
       expect resp.http.x-via == "hit"
} -run

# Softpurge the object.
client c1 {
       txreq -req "PURGE" -url "/"
       rxresp
       expect resp.http.x-via == "hit"
} -run


